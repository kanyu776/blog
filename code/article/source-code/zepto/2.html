<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>core 模块 | 戡玉的个人博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="业精于勤荒于嬉，行成于思毁于随">
    
    <link rel="preload" href="/blog/assets/css/0.styles.cb6842fd.css" as="style"><link rel="preload" href="/blog/assets/js/app.f95532c7.js" as="script"><link rel="preload" href="/blog/assets/js/2.d291a91f.js" as="script"><link rel="preload" href="/blog/assets/js/1.eb9a41bf.js" as="script"><link rel="preload" href="/blog/assets/js/48.465cd1a5.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.5458d4b5.js"><link rel="prefetch" href="/blog/assets/js/100.008b1e11.js"><link rel="prefetch" href="/blog/assets/js/101.11ac553a.js"><link rel="prefetch" href="/blog/assets/js/102.d1a1e243.js"><link rel="prefetch" href="/blog/assets/js/103.6cc578f2.js"><link rel="prefetch" href="/blog/assets/js/104.def1fa39.js"><link rel="prefetch" href="/blog/assets/js/105.808c1717.js"><link rel="prefetch" href="/blog/assets/js/106.04506ad8.js"><link rel="prefetch" href="/blog/assets/js/107.8d0bff97.js"><link rel="prefetch" href="/blog/assets/js/108.e665ee7e.js"><link rel="prefetch" href="/blog/assets/js/109.fea08bd3.js"><link rel="prefetch" href="/blog/assets/js/11.6dec87a5.js"><link rel="prefetch" href="/blog/assets/js/110.a6cdd405.js"><link rel="prefetch" href="/blog/assets/js/111.c58aa255.js"><link rel="prefetch" href="/blog/assets/js/112.e8be0755.js"><link rel="prefetch" href="/blog/assets/js/113.03895dfa.js"><link rel="prefetch" href="/blog/assets/js/114.9a30bb2a.js"><link rel="prefetch" href="/blog/assets/js/115.4cfeab92.js"><link rel="prefetch" href="/blog/assets/js/116.90952127.js"><link rel="prefetch" href="/blog/assets/js/117.52e6938e.js"><link rel="prefetch" href="/blog/assets/js/118.5fbcaa03.js"><link rel="prefetch" href="/blog/assets/js/119.8ead66c6.js"><link rel="prefetch" href="/blog/assets/js/12.4b0e6367.js"><link rel="prefetch" href="/blog/assets/js/120.995f0c9f.js"><link rel="prefetch" href="/blog/assets/js/121.24591e4e.js"><link rel="prefetch" href="/blog/assets/js/122.86dd3522.js"><link rel="prefetch" href="/blog/assets/js/123.f868c5f2.js"><link rel="prefetch" href="/blog/assets/js/124.205a9680.js"><link rel="prefetch" href="/blog/assets/js/125.006ef9e6.js"><link rel="prefetch" href="/blog/assets/js/13.b0de7978.js"><link rel="prefetch" href="/blog/assets/js/14.2286727c.js"><link rel="prefetch" href="/blog/assets/js/15.f8079179.js"><link rel="prefetch" href="/blog/assets/js/16.e8e68b8f.js"><link rel="prefetch" href="/blog/assets/js/17.7daa3dd4.js"><link rel="prefetch" href="/blog/assets/js/18.772333af.js"><link rel="prefetch" href="/blog/assets/js/19.3fa31704.js"><link rel="prefetch" href="/blog/assets/js/20.84e91d21.js"><link rel="prefetch" href="/blog/assets/js/21.fe5c292d.js"><link rel="prefetch" href="/blog/assets/js/22.44e2d82e.js"><link rel="prefetch" href="/blog/assets/js/23.78b1fd62.js"><link rel="prefetch" href="/blog/assets/js/24.9649af90.js"><link rel="prefetch" href="/blog/assets/js/25.4330e553.js"><link rel="prefetch" href="/blog/assets/js/26.58c40450.js"><link rel="prefetch" href="/blog/assets/js/27.85901095.js"><link rel="prefetch" href="/blog/assets/js/28.94a6b4e0.js"><link rel="prefetch" href="/blog/assets/js/29.18d606f7.js"><link rel="prefetch" href="/blog/assets/js/3.8276b9a5.js"><link rel="prefetch" href="/blog/assets/js/30.2c3309a3.js"><link rel="prefetch" href="/blog/assets/js/31.4ccf3bec.js"><link rel="prefetch" href="/blog/assets/js/32.94b55d15.js"><link rel="prefetch" href="/blog/assets/js/33.01e39262.js"><link rel="prefetch" href="/blog/assets/js/34.3ba4e724.js"><link rel="prefetch" href="/blog/assets/js/35.a1bf00ac.js"><link rel="prefetch" href="/blog/assets/js/36.c76dcab4.js"><link rel="prefetch" href="/blog/assets/js/37.4e6efb91.js"><link rel="prefetch" href="/blog/assets/js/38.3dafa69a.js"><link rel="prefetch" href="/blog/assets/js/39.fb24fa61.js"><link rel="prefetch" href="/blog/assets/js/4.3e09a12a.js"><link rel="prefetch" href="/blog/assets/js/40.8604ca4b.js"><link rel="prefetch" href="/blog/assets/js/41.dee22dc6.js"><link rel="prefetch" href="/blog/assets/js/42.7d2b58f9.js"><link rel="prefetch" href="/blog/assets/js/43.97b124a7.js"><link rel="prefetch" href="/blog/assets/js/44.cfc76ead.js"><link rel="prefetch" href="/blog/assets/js/45.8e74e262.js"><link rel="prefetch" href="/blog/assets/js/46.851acbea.js"><link rel="prefetch" href="/blog/assets/js/47.eb595ca2.js"><link rel="prefetch" href="/blog/assets/js/49.34cda34f.js"><link rel="prefetch" href="/blog/assets/js/5.1be809ca.js"><link rel="prefetch" href="/blog/assets/js/50.086f06b8.js"><link rel="prefetch" href="/blog/assets/js/51.eaca8d99.js"><link rel="prefetch" href="/blog/assets/js/52.aca19aef.js"><link rel="prefetch" href="/blog/assets/js/53.be2f51b9.js"><link rel="prefetch" href="/blog/assets/js/54.0d23ae7e.js"><link rel="prefetch" href="/blog/assets/js/55.66cac580.js"><link rel="prefetch" href="/blog/assets/js/56.36104753.js"><link rel="prefetch" href="/blog/assets/js/57.8dd57a6e.js"><link rel="prefetch" href="/blog/assets/js/58.7ccf88ea.js"><link rel="prefetch" href="/blog/assets/js/59.c88dc68b.js"><link rel="prefetch" href="/blog/assets/js/6.9cdb95d4.js"><link rel="prefetch" href="/blog/assets/js/60.b41214b8.js"><link rel="prefetch" href="/blog/assets/js/61.2b392f10.js"><link rel="prefetch" href="/blog/assets/js/62.bf4ee67d.js"><link rel="prefetch" href="/blog/assets/js/63.559bb6ca.js"><link rel="prefetch" href="/blog/assets/js/64.280de08d.js"><link rel="prefetch" href="/blog/assets/js/65.525da292.js"><link rel="prefetch" href="/blog/assets/js/66.ee2c53b4.js"><link rel="prefetch" href="/blog/assets/js/67.8a5fa8c9.js"><link rel="prefetch" href="/blog/assets/js/68.14b2e5cd.js"><link rel="prefetch" href="/blog/assets/js/69.5d1c5820.js"><link rel="prefetch" href="/blog/assets/js/7.fa2ecde9.js"><link rel="prefetch" href="/blog/assets/js/70.6bc6986a.js"><link rel="prefetch" href="/blog/assets/js/71.39ca37cb.js"><link rel="prefetch" href="/blog/assets/js/72.a309f6ea.js"><link rel="prefetch" href="/blog/assets/js/73.475c676e.js"><link rel="prefetch" href="/blog/assets/js/74.c56a6344.js"><link rel="prefetch" href="/blog/assets/js/75.645ee1f7.js"><link rel="prefetch" href="/blog/assets/js/76.1fbce9a1.js"><link rel="prefetch" href="/blog/assets/js/77.bf5956e2.js"><link rel="prefetch" href="/blog/assets/js/78.84e91ea3.js"><link rel="prefetch" href="/blog/assets/js/79.dd037aa7.js"><link rel="prefetch" href="/blog/assets/js/80.509e2744.js"><link rel="prefetch" href="/blog/assets/js/81.13c24b30.js"><link rel="prefetch" href="/blog/assets/js/82.c54d1196.js"><link rel="prefetch" href="/blog/assets/js/83.db64d1b9.js"><link rel="prefetch" href="/blog/assets/js/84.462a3eb1.js"><link rel="prefetch" href="/blog/assets/js/85.e878d5cf.js"><link rel="prefetch" href="/blog/assets/js/86.58d41cc5.js"><link rel="prefetch" href="/blog/assets/js/87.9ba3e564.js"><link rel="prefetch" href="/blog/assets/js/88.e112cf8a.js"><link rel="prefetch" href="/blog/assets/js/89.0682d83b.js"><link rel="prefetch" href="/blog/assets/js/90.12d51230.js"><link rel="prefetch" href="/blog/assets/js/91.caedbca9.js"><link rel="prefetch" href="/blog/assets/js/92.095d6116.js"><link rel="prefetch" href="/blog/assets/js/93.6576884f.js"><link rel="prefetch" href="/blog/assets/js/94.5c319988.js"><link rel="prefetch" href="/blog/assets/js/95.af26136a.js"><link rel="prefetch" href="/blog/assets/js/96.194b001d.js"><link rel="prefetch" href="/blog/assets/js/97.175674ae.js"><link rel="prefetch" href="/blog/assets/js/98.f5682594.js"><link rel="prefetch" href="/blog/assets/js/99.cd78756a.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.1618c296.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.cb6842fd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">戡玉的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link router-link-active">
  技术
</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link router-link-active">
  技术
</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>文章</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>web前端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>游览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>源码分析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/blog/code/article/source-code/zepto/1" class="sidebar-heading clickable open"><span>zepto</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/code/article/source-code/zepto/1.html" class="sidebar-link">整体架构</a></li><li><a href="/blog/code/article/source-code/zepto/2.html" aria-current="page" class="active sidebar-link">core 模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/code/article/source-code/zepto/2.html#准备说明" class="sidebar-link">准备说明</a></li><li class="sidebar-sub-header"><a href="/blog/code/article/source-code/zepto/2.html#实现内容" class="sidebar-link">实现内容</a></li><li class="sidebar-sub-header"><a href="/blog/code/article/source-code/zepto/2.html#重点分析" class="sidebar-link">重点分析</a></li><li class="sidebar-sub-header"><a href="/blog/code/article/source-code/zepto/2.html#其他-api-方法" class="sidebar-link">其他 api 方法</a></li></ul></li><li><a href="/blog/code/article/source-code/zepto/3.html" class="sidebar-link">event 模块</a></li><li><a href="/blog/code/article/source-code/zepto/4.html" class="sidebar-link">ajax 模块</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>总结</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="core-模块"><a href="#core-模块" class="header-anchor">#</a> core 模块</h1> <h2 id="准备说明"><a href="#准备说明" class="header-anchor">#</a> 准备说明</h2> <ul><li><p>该模块定义了库的原型链结构，生成了 Zepto 变量，并将其以'Zepto'和'$'的名字注册到了 window，然后开始了其它模块的拓展实现。</p></li> <li><p>模块内部除了对选择器和 zepto 对象的实现，就是一些工具方法和原型方法的定义。</p></li> <li><p>值得一提的是，内部很多实现都利用了原生数组的方法，很多 api 也是基于内部或公开的方法进一步拓展实现的。</p></li> <li><p>虽然该模块涉及的 api 非常多，但内部实现上比较统一，因此只会针对性地挑一些方法进行分析。</p></li></ul> <h2 id="实现内容"><a href="#实现内容" class="header-anchor">#</a> 实现内容</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Zepto <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.基础变量定义</span>
    <span class="token comment">// 2.内部方法实现</span>
    <span class="token comment">// 3.zepto对象实现——$('选择器')</span>
    <span class="token comment">// 4.$.extend方法实现</span>
    <span class="token comment">// 5.zepto.qsa内部方法和其它5个内部方法</span>
    <span class="token comment">// 6.全局方法实现——$.方法</span>
    <span class="token comment">// 7.原型方法实现——$().方法</span>
    <span class="token comment">// 8.原型链结构设置</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>上面是主体实现内容，代码定义顺序大致如上，某些地方会穿插定义</li></ul> <h2 id="重点分析"><a href="#重点分析" class="header-anchor">#</a> 重点分析</h2> <h3 id="选择器"><a href="#选择器" class="header-anchor">#</a> 选择器</h3> <p>选择器的实现逻辑放在了 zepto.init 方法中，由$()内部调用 zepto.init 方法，先处理选择器生成 dom 集合，然后将集合传入能生成 zepto 对象的内部方法，主体逻辑如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>zepto<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.如果selector为空</span>
  <span class="token comment">// 2.如果selector为字符串</span>
  <span class="token comment">// a.标签字符串形式</span>
  <span class="token comment">// b.context存在的处理</span>
  <span class="token comment">// c.css选择器</span>
  <span class="token comment">// 3.如果selector为方法</span>
  <span class="token comment">// 4.如果selector为zepto对象</span>
  <span class="token comment">// 5.如果selector为其它情况</span>
  <span class="token comment">// 6.执行zepto对象生成方法</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="源码如下"><a href="#源码如下" class="header-anchor">#</a> 源码如下</h3> <div class="language-js extra-class"><pre class="language-js"><code>zepto<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> dom<span class="token punctuation">;</span>
  <span class="token comment">// 如果selector不存在(返回一个空的zepto对象)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selector<span class="token punctuation">)</span> <span class="token keyword">return</span> zepto<span class="token punctuation">.</span><span class="token constant">Z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果selector为字符串</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> selector <span class="token operator">==</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    selector <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果是标签字符串形式(在Chrome 21 and Firefox 15中，如果选择器不以'&lt;'开头，会引发dom错误)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;&lt;&quot;</span> <span class="token operator">&amp;&amp;</span> fragmentRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span>dom <span class="token operator">=</span> zepto<span class="token punctuation">.</span><span class="token function">fragment</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> RegExp<span class="token punctuation">.</span>$1<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>selector <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果存在context属性，则应该以它为基础往下查找</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果是css选择器</span>
    <span class="token keyword">else</span> dom <span class="token operator">=</span> zepto<span class="token punctuation">.</span><span class="token function">qsa</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果selector是方法</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果是zepto对象(直接返回)</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>zepto<span class="token punctuation">.</span><span class="token function">isZ</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> selector<span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是本身数组，则去掉不存在的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span> dom <span class="token operator">=</span> <span class="token function">compact</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果是对象，则存为数组形式</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>dom <span class="token operator">=</span> <span class="token punctuation">[</span>selector<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>selector <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里重复了typeof selector == 'string'时的判断</span>
    <span class="token comment">// 因为typeof无法让new String()包装类型进入条件，因此通过最后的else再进行一次判断</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fragmentRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span>dom <span class="token operator">=</span> zepto<span class="token punctuation">.</span><span class="token function">fragment</span><span class="token punctuation">(</span>selector<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RegExp<span class="token punctuation">.</span>$1<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>selector <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> dom <span class="token operator">=</span> zepto<span class="token punctuation">.</span><span class="token function">qsa</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 创建zepto集合</span>
  <span class="token keyword">return</span> zepto<span class="token punctuation">.</span><span class="token constant">Z</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="zepto-qsa-方法"><a href="#zepto-qsa-方法" class="header-anchor">#</a> zepto.qsa 方法</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 处理css选择器的情况</span>
zepto<span class="token punctuation">.</span><span class="token function-variable function">qsa</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> selector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> found<span class="token punctuation">,</span>
    maybeID <span class="token operator">=</span> selector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;#&quot;</span><span class="token punctuation">,</span>
    maybeClass <span class="token operator">=</span> <span class="token operator">!</span>maybeID <span class="token operator">&amp;&amp;</span> selector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span>
    nameOnly <span class="token operator">=</span> maybeID <span class="token operator">||</span> maybeClass <span class="token operator">?</span> selector<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> selector<span class="token punctuation">,</span>
    <span class="token comment">// 是否为单一形式的选择器而非复杂形式</span>
    isSimple <span class="token operator">=</span> simpleSelectorRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>nameOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> element<span class="token punctuation">.</span>getElementById <span class="token operator">&amp;&amp;</span> isSimple <span class="token operator">&amp;&amp;</span> maybeID <span class="token comment">// Safari游览器的DocumentFrament没有getElementById方法</span>
    <span class="token operator">?</span> <span class="token comment">// id选择器处理</span>
      <span class="token punctuation">(</span>found <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>nameOnly<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token punctuation">[</span>found<span class="token punctuation">]</span>
      <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token operator">:</span> <span class="token comment">// 非id选择器处理</span>
    element<span class="token punctuation">.</span>nodeType <span class="token operator">!==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> element<span class="token punctuation">.</span>nodeType <span class="token operator">!==</span> <span class="token number">9</span> <span class="token operator">&amp;&amp;</span> element<span class="token punctuation">.</span>nodeType <span class="token operator">!==</span> <span class="token number">11</span>
    <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token operator">:</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
        isSimple <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>maybeID <span class="token operator">&amp;&amp;</span> element<span class="token punctuation">.</span>getElementsByClassName <span class="token comment">// DocumentFragment没有getElementsByClassName/TagName方法</span>
          <span class="token operator">?</span> maybeClass
            <span class="token operator">?</span> element<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span>nameOnly<span class="token punctuation">)</span> <span class="token comment">// 如果是class</span>
            <span class="token operator">:</span> element<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token comment">// 如果是标签</span>
          <span class="token operator">:</span> element<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token comment">// 其它都用querySelectorAll处理</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="zepto-fragment-方法"><a href="#zepto-fragment-方法" class="header-anchor">#</a> zepto.fragment 方法</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 处理标签字符串的情况</span>
zepto<span class="token punctuation">.</span><span class="token function-variable function">fragment</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> name<span class="token punctuation">,</span> properties</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> dom<span class="token punctuation">,</span> nodes<span class="token punctuation">,</span> container<span class="token punctuation">;</span>
  <span class="token comment">// 如果是无标签内容的标签，则直接创建并赋值给dom变量</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>singleTagRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> dom <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>$1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果是有内容的标签，则走其他的判断流程</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保证标签字符串为双标签形式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>tagExpanderRE<span class="token punctuation">,</span> <span class="token string">&quot;&lt;$1&gt;&lt;/$2&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果没有从html字符串中获取到标签名，则再次获取</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> name <span class="token operator">=</span> fragmentRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> RegExp<span class="token punctuation">.</span>$1<span class="token punctuation">;</span>
    <span class="token comment">// 如果标签名为非常规字符串，则name置为'*'，容器container设置为div</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>name <span class="token keyword">in</span> containers<span class="token punctuation">)</span><span class="token punctuation">)</span> name <span class="token operator">=</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过容器标签将html字符串dom化</span>
    container <span class="token operator">=</span> containers<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> html<span class="token punctuation">;</span>
    <span class="token comment">// 返回dom集合，清空container</span>
    dom <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>childNodes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果是纯粹的object对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nodes <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>properties<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是库的特殊属性名，则应该通过方法调用</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>methodAttributes<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> nodes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果不是，则设置集合的节点属性</span>
      <span class="token keyword">else</span> nodes<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="zepto-对象"><a href="#zepto-对象" class="header-anchor">#</a> zepto 对象</h3> <p>Zepto 对象的生成依赖于一连串相关的内部方法，源码实现如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// zepto对象工厂————第四步</span>
<span class="token keyword">function</span> <span class="token constant">Z</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> selector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> i<span class="token punctuation">,</span>
    len <span class="token operator">=</span> dom <span class="token operator">?</span> dom<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> dom<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> len<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>selector <span class="token operator">=</span> selector <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 处理标签字符串</span>
zepto<span class="token punctuation">.</span><span class="token function-variable function">fragment</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> name<span class="token punctuation">,</span> properties</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 源码不再赘述...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 生成zepto对象————第三步</span>
zepto<span class="token punctuation">.</span><span class="token function-variable function">Z</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> selector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 通过模块的原型链结构，可获得各种操作方法</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Z</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 判断是否为zepto对象</span>
zepto<span class="token punctuation">.</span><span class="token function-variable function">isZ</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> object <span class="token keyword">instanceof</span> <span class="token class-name">zepto<span class="token punctuation">.</span>Z</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 生成dom集合，然后进行zepto集合创建————第二步</span>
zepto<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生成dom集合</span>
  <span class="token comment">// 执行zepto.Z方法</span>
  <span class="token comment">// 源码不再赘述...</span>
  <span class="token keyword">return</span> zepto<span class="token punctuation">.</span><span class="token constant">Z</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 获取zepto对象————第一步</span>
<span class="token function-variable function">$</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> zepto<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 处理css选择器</span>
zepto<span class="token punctuation">.</span><span class="token function-variable function">qsa</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> selector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 源码不再赘述...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 设置原型方法</span>
$<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 设置原型链结构</span>
zepto<span class="token punctuation">.</span><span class="token class-name">Z</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token class-name">Z</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> $<span class="token punctuation">.</span>fn<span class="token punctuation">;</span>

<span class="token comment">// 返回给外部Zepto变量，然后通过window注册</span>
<span class="token keyword">return</span> $<span class="token punctuation">;</span>
</code></pre></div><h2 id="其他-api-方法"><a href="#其他-api-方法" class="header-anchor">#</a> 其他 api 方法</h2> <ul><li><p>工具方法和原型方法太多，只能挑几个典型了</p></li> <li><p>extend 和 ready 的实现都比较简单</p></li> <li><p>css 方法的实现主要还是对原生 element.style 和 getComputedStyle 的熟悉，对属性名转换和样式单位的自动添加的考虑</p></li> <li><p>插入操作的几个方法实现比较精巧，可以认真研究下</p></li></ul> <h3 id="extend"><a href="#extend" class="header-anchor">#</a> $.extend</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> source<span class="token punctuation">,</span> deep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是深拷贝</span>
  <span class="token comment">// isArray判断是否为数组类型</span>
  <span class="token comment">// isPlainObject判断是否为纯粹的object类型</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> source<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deep <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果拷贝对象的属性值为Object，而目标对象的属性值不为Object，则目标对象的属性值重置为Object</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果拷贝对象的属性值为Array，而目标对象的属性值不为Array，则目标对象的属性值重置为Array</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 进行深拷贝</span>
      <span class="token function">extend</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> deep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果是浅拷贝</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

$<span class="token punctuation">.</span><span class="token function-variable function">extend</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> deep<span class="token punctuation">,</span>
    args <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果存在深/浅拷贝设置</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">==</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存储深浅拷贝判断值</span>
    deep <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token comment">// 获得目标对象</span>
    target <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 遍历拷贝对象</span>
  args<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">extend</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> deep<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="fn-ready"><a href="#fn-ready" class="header-anchor">#</a> $.fn.ready</h3> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">ready</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 需要检查IE是否存在document.body，因为浏览器在尚未创建body元素时会报告文档就绪</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>readyRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token function">callback</span><span class="token punctuation">(</span>$<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">callback</span><span class="token punctuation">(</span>$<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="fn-css"><a href="#fn-css" class="header-anchor">#</a> $.fn.css</h3> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">css</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">property<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是获取属性(参数小于2)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 取第一个元素</span>
      <span class="token keyword">var</span> element <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果是字符串类型</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> property <span class="token operator">==</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>element<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token comment">// element.style用于访问直接样式，getComputedStyle用于访问层叠后的样式</span>
        <span class="token comment">// camelize方法用于将a-b，转换aB，驼峰转换</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
          element<span class="token punctuation">.</span>style<span class="token punctuation">[</span><span class="token function">camelize</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">||</span>
          <span class="token function">getComputedStyle</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果是数组类型</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>element<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 存储层叠样式集</span>
        <span class="token keyword">var</span> computedStyle <span class="token operator">=</span> <span class="token function">getComputedStyle</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历数组样式名，生成样式对象props返回</span>
        $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          props<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span>
            element<span class="token punctuation">.</span>style<span class="token punctuation">[</span><span class="token function">camelize</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">||</span>
            computedStyle<span class="token punctuation">.</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> props<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> css <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果属性值不存在，遍历删除</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">removeProperty</span><span class="token punctuation">(</span><span class="token function">dasherize</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// dasherize用于将property规范化为'a-b'形式</span>
      <span class="token comment">// maybeAddPx用于自动增加px</span>
      <span class="token keyword">else</span> css <span class="token operator">=</span> <span class="token function">dasherize</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token function">maybeAddPx</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果属性值不存在，遍历删除</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> property<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>property<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">removeProperty</span><span class="token punctuation">(</span><span class="token function">dasherize</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> css <span class="token operator">+=</span> <span class="token function">dasherize</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token function">maybeAddPx</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> property<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 遍历设置样式字符串</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">+=</span> <span class="token string">&quot;;&quot;</span> <span class="token operator">+</span> css<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="fn-插入"><a href="#fn-插入" class="header-anchor">#</a> $.fn.插入</h3> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 递归执行节点处理函数</span>
    <span class="token keyword">function</span> <span class="token function">traverseNode</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> fun</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fun</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">traverseNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> fun<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// after|before|append|prepend与insertAfter|insertBefore|appendTo|prepend实现</span>
    <span class="token comment">// adjacencyOperators = [ 'after', 'prepend', 'before', 'append' ]</span>
    adjacencyOperators<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">operator<span class="token punctuation">,</span> operatorIndex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// inside为0和2, after|before(标签外插入)</span>
      <span class="token comment">// inside为1和3, append|prepend(标签内插入)</span>
      <span class="token keyword">var</span> inside <span class="token operator">=</span> operatorIndex <span class="token operator">%</span> <span class="token number">2</span>

      <span class="token comment">// after|before|append|prepend实现</span>
      $<span class="token punctuation">.</span>fn<span class="token punctuation">[</span>operator<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 获得dom数组</span>
        <span class="token keyword">var</span> argType<span class="token punctuation">,</span> nodes <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
              <span class="token comment">// 判断参数项类型</span>
              argType <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
              <span class="token comment">// 如果是array类型，处理成dom数组返回</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>argType <span class="token operator">==</span> <span class="token string">&quot;array&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                arg<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment">// 如果el是dom对象</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>nodeType <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
                  <span class="token comment">// 如果el是zepto对象</span>
                  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">.</span>zepto<span class="token punctuation">.</span><span class="token function">isZ</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token comment">// 如果el是标签字符串</span>
                  arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>zepto<span class="token punctuation">.</span><span class="token function">fragment</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> arr
              <span class="token punctuation">}</span>
              <span class="token comment">// 如果为object类型或不为null，就返回自身；否则作为标签字符串处理，返回dom</span>
              <span class="token keyword">return</span> argType <span class="token operator">==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> arg <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span>
                <span class="token literal-property property">arg</span> <span class="token operator">:</span> zepto<span class="token punctuation">.</span><span class="token function">fragment</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            parent<span class="token punctuation">,</span> copyByClone <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span>

        <span class="token comment">// 如果不存在，则返回自身</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nodes<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span>

        <span class="token comment">// 处理dom数组</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// inside为0和2, 处理的是after|before, 用父级做容器</span>
          <span class="token comment">// inside为1和3, 处理的是append|prepend, 用自身做容器</span>
          parent <span class="token operator">=</span> inside <span class="token operator">?</span> target <span class="token operator">:</span> target<span class="token punctuation">.</span>parentNode
          <span class="token comment">// target在insertBefore方法中用作参照点</span>
          <span class="token comment">// operatorIndex == 0, 操作的是after方法, 取下一个节点</span>
          <span class="token comment">// operatorIndex == 1, 操作的是prepend方法, 取第一个子节点</span>
          <span class="token comment">// operatorIndex == 2, 操作的是before方法, 取自身</span>
          <span class="token comment">// operatorIndex == 3, 操作的是append方法, 取null</span>
          target <span class="token operator">=</span> operatorIndex <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>nextSibling <span class="token operator">:</span>
                   operatorIndex <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>firstChild <span class="token operator">:</span>
                   operatorIndex <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">?</span> target <span class="token operator">:</span>
                   <span class="token keyword">null</span>
          <span class="token comment">// 是否在html内</span>
          <span class="token keyword">var</span> parentInDocument <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>documentElement<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
          <span class="token comment">// 遍历处理插入的节点</span>
          nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 因为操作对象可能有多个, 而被插入node只有1个</span>
            <span class="token comment">// 如果要让所有操作对象都被插入内容，需要对插入node进行深克隆</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>copyByClone<span class="token punctuation">)</span> node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token comment">// 如果不存在parent，则删除插入的节点</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parent<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 插入节点</span>
            parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
            <span class="token comment">// 如果在html内，就递归执行，遇到有js代码的script标签，就执行它</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parentInDocument<span class="token punctuation">)</span> <span class="token function">traverseNode</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>nodeName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'SCRIPT'</span> <span class="token operator">&amp;&amp;</span>
                 <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>type <span class="token operator">||</span> el<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// 这里用到ownerDocument判断而不直接用window，是考虑到页面有可能是iframe引入的</span>
                <span class="token keyword">var</span> target <span class="token operator">=</span> el<span class="token punctuation">.</span>ownerDocument <span class="token operator">?</span> el<span class="token punctuation">.</span>ownerDocument<span class="token punctuation">.</span>defaultView <span class="token operator">:</span> window
                target<span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> el<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// insertAfter|insertBefore|appendTo|prepend实现</span>
      $<span class="token punctuation">.</span>fn<span class="token punctuation">[</span>inside <span class="token operator">?</span> operator<span class="token operator">+</span><span class="token string">'To'</span> <span class="token operator">:</span> <span class="token string">'insert'</span><span class="token operator">+</span><span class="token punctuation">(</span>operatorIndex <span class="token operator">?</span> <span class="token string">'Before'</span> <span class="token operator">:</span> <span class="token string">'After'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">[</span>operator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/code/article/source-code/zepto/1.html" class="prev">
        整体架构
      </a></span> <span class="next"><a href="/blog/code/article/source-code/zepto/3.html">
        event 模块
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.f95532c7.js" defer></script><script src="/blog/assets/js/2.d291a91f.js" defer></script><script src="/blog/assets/js/1.eb9a41bf.js" defer></script><script src="/blog/assets/js/48.465cd1a5.js" defer></script>
  </body>
</html>
